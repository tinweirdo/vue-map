<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <script type="text/javascript"
            src="../../../../res/include-leaflet.js" 
            libpath="../../../../res/"
        include="jquery"></script>
    <link href="../popup.css" rel="stylesheet" />
    <script>
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        }

        (function () {
            /// <summary>
            /// 引号转义符号
            /// </summary>
            String.EscapeChar = '\'';

            /// <summary>
            /// 替换所有字符串
            /// </summary>
            /// <param name="searchValue">检索值</param>
            /// <param name="replaceValue">替换值</param>
            String.prototype.replaceAll = function (searchValue, replaceValue) {
                var regExp = new RegExp(searchValue, "g");
                return this.replace(regExp, replaceValue);
            }

            /// <summary>
            /// 格式化字符串
            /// </summary>
            String.prototype.format = function () {
                var regexp = /\{(\d+)\}/g;
                var args = arguments;
                var result = this.replace(regexp, function (m, i, o, n) {
                    return args[i];
                });
                return result.replaceAll('%', String.EscapeChar);
            }
        })();
        var id = getQueryString("id");
        var url = getQueryString("url");
        var name = null;
        this.parent.L.esri.query({
            url: url
        }).where('"objectId"=' + id).run(function (error, results) {
            if (results == null) return;
            var feaSet = results.features;
            var mainDiv = document.getElementById("context");
            var html = "<table width='100%' height='100%'   >";
            if (feaSet.length > 0) {
                getpopupHtml(feaSet[0], mainDiv);
            }

        });


        function getpopupHtml(feature, mainDiv) {
            $.getJSON("../popup_gd.json", "", function (jsondata) {
                var html = "<table width='100%' height='100%'   >";
                for (var i = 0; i < jsondata.fields.length; i++) {
                    var name = jsondata.fields[i].field.name;
                    var alias = jsondata.fields[i].field.alias;
                    var translateType = jsondata.fields[i].field.translateType;
                    var unit = jsondata.fields[i].field.unit
                    if (translateType) {
                        var translate = getAlais(translateType, feature.properties[name]);
                        html += "<tr><td  width='90px'>" + alias + ":</td><td>" + translate + "</td></tr>";
                    }
                    else {
                        if (unit != null && unit != undefined && unit != '')
                            html += "<tr><td  width='90px'>" + alias + ":</td><td>" + feature.properties[name] + " " + unit + "</td></tr>";
                        else
                            html += "<tr><td  width='90px'>" + alias + ":</td><td>" + feature.properties[name] + "</td></tr>";
                    }
                }
                html += "</table>";
                mainDiv.innerHTML = html;
                document.getElementById("popTitle").innerHTML = feature.properties[jsondata.title];
            });
        }

        function getAlais(translateType, value) {

            for (var i = 0; i < translateType.length; i++) {
                if (translateType[i].name == value) {
                    return translateType[i].alias;
                }
            }
        }


    </script>
</head>

<body>

    <div class="title">
        <span id="popTitle"></span>
    </div>
    <div id="context" class='context'>


    </div>
</body>

</html>